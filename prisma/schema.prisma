// Dottorio - Database Schema
// PostgreSQL via Docker (porta 5434)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENTIDADES BASE
// ============================================

model University {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(150)
  shortName String?  @map("short_name") @db.VarChar(50)
  city      String?  @db.VarChar(100)
  emoji     String?  @db.VarChar(10)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  professors Professor[]
  users      User[]
  courses    Course[]
  exams      Exam[]

  @@map("universities")
}

model Course {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100) // "Medicina Canale A", "Farmacia", etc.
  universityId String   @map("university_id")
  year         Int?     @db.SmallInt // Ano do curso (1-6)
  emoji        String?  @db.VarChar(10)
  description  String?  @db.VarChar(255)
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  university University @relation(fields: [universityId], references: [id])
  users      User[]
  subjects   Subject[]
  exams      Exam[]

  @@unique([universityId, name])
  @@index([universityId])
  @@map("courses")
}

model Subject {
  id        String   @id @default(uuid())
  name      String   @db.VarChar(100)
  courseId  String   @map("course_id")
  emoji     String?  @db.VarChar(10)
  color     String?  @db.VarChar(20)
  semester  Int?     @db.SmallInt // 1 ou 2
  year      Int?     @db.SmallInt // Ano em que a matéria é ministrada (1-6)
  credits   Int?     @db.SmallInt // Créditos/CFU
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  course     Course             @relation(fields: [courseId], references: [id], onDelete: Cascade)
  professors ProfessorSubject[]
  exams      Exam[]

  @@unique([courseId, name])
  @@index([courseId])
  @@map("subjects")
}

model Professor {
  id           String   @id @default(uuid())
  name         String   @db.VarChar(100)
  email        String?  @db.VarChar(255)
  universityId String   @map("university_id")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  university University         @relation(fields: [universityId], references: [id])
  subjects   ProfessorSubject[]
  exams      Exam[]

  @@index([universityId])
  @@map("professors")
}

model ProfessorSubject {
  id          String @id @default(uuid())
  professorId String @map("professor_id")
  subjectId   String @map("subject_id")

  // Relations
  professor Professor @relation(fields: [professorId], references: [id], onDelete: Cascade)
  subject   Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([professorId, subjectId])
  @@map("professor_subjects")
}

// ============================================
// USUÁRIOS
// ============================================

model User {
  id               String    @id @default(uuid())
  email            String    @unique @db.VarChar(255)
  passwordHash     String    @map("password_hash") @db.VarChar(255)
  name             String    @db.VarChar(100)
  universityId     String    @map("university_id")
  courseId         String?   @map("course_id")
  year             Int       @db.SmallInt // 1, 2, 3, 4, 5, 6
  isRepresentative Boolean   @default(false) @map("is_representative")
  role             String    @default("student") @db.VarChar(30) // student, representative, admin, super_admin
  status           String    @default("active") @db.VarChar(30) // active, suspended, banned
  avatarUrl        String?   @map("avatar_url")
  lastLoginAt      DateTime? @map("last_login_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  university     University    @relation(fields: [universityId], references: [id])
  course         Course?       @relation(fields: [courseId], references: [id])
  exams          Exam[]
  studentAnswers StudentAnswer[]
  answerLikes    AnswerLike[]
  comments       Comment[]
  commentLikes   CommentLike[]
  savedQuestions SavedQuestion[]
  aiRatings      AiRating[]
  auditLogs      AuditLog[]
  reportedFlags  ContentFlag[] @relation("FlagReportedBy")
  reviewedFlags  ContentFlag[] @relation("FlagReviewedBy")
  shareLinks     ShareLink[]

  @@index([universityId])
  @@index([courseId])
  @@index([role])
  @@index([status])
  @@map("users")
}

// ============================================
// EXAMES E QUESTÕES (ENTIDADE CENTRAL)
// ============================================

model Exam {
  id           String    @id @default(uuid())
  subjectId    String    @map("subject_id")
  professorId  String?   @map("professor_id")
  universityId String    @map("university_id")
  courseId     String?   @map("course_id")
  year         Int?      @db.SmallInt // 1, 2, 3, 4, 5, 6 (ano do curso)
  examDate     DateTime? @map("exam_date") @db.Date
  examType     String    @default("orale") @map("exam_type") @db.VarChar(30) // orale, scritto, pratico
  academicYear String?   @map("academic_year") @db.VarChar(20) // 2024/2025
  description  String?
  createdBy    String?   @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  subject   Subject    @relation(fields: [subjectId], references: [id])
  professor Professor? @relation(fields: [professorId], references: [id])
  university University @relation(fields: [universityId], references: [id])
  course    Course?    @relation(fields: [courseId], references: [id])
  creator    User?       @relation(fields: [createdBy], references: [id])
  questions  Question[]
  shareLinks ShareLink[]

  @@index([subjectId])
  @@index([professorId])
  @@index([universityId])
  @@index([courseId])
  @@index([examDate])
  @@map("exams")
}

model Question {
  id         String   @id @default(uuid())
  examId     String   @map("exam_id")
  text       String
  order      Int      @default(1) @db.SmallInt
  timesAsked Int      @default(1) @map("times_asked")
  views      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")

  // Question Variations System
  groupId     String?  @map("group_id")
  isCanonical Boolean  @default(true) @map("is_canonical")
  canonicalId String?  @map("canonical_id")

  // Relations
  exam           Exam            @relation(fields: [examId], references: [id], onDelete: Cascade)
  aiAnswer       AiAnswer?
  studentAnswers StudentAnswer[]
  comments       Comment[]
  savedBy        SavedQuestion[]

  // Self-relation for variations
  canonical  Question?  @relation("QuestionVariations", fields: [canonicalId], references: [id])
  variations Question[] @relation("QuestionVariations")

  @@index([examId])
  @@index([groupId])
  @@index([canonicalId])
  @@index([isCanonical])
  @@index([views])
  @@index([createdAt])
  @@map("questions")
}

// ============================================
// RESPOSTAS
// ============================================

model AiAnswer {
  id         String   @id @default(uuid())
  questionId String   @unique @map("question_id")
  content    String
  source     String?  // Fonte da resposta (ex: "Capitolo 12 - Anatomia Umana di Martini")
  model      String?  @db.VarChar(50) // gpt-4, gpt-4o, claude-3
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  question Question   @relation(fields: [questionId], references: [id], onDelete: Cascade)
  ratings  AiRating[]

  @@map("ai_answers")
}

model StudentAnswer {
  id         String   @id @default(uuid())
  questionId String   @map("question_id")
  userId     String   @map("user_id")
  content    String
  isPublic   Boolean  @default(false) @map("is_public")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  question Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user     User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes    AnswerLike[]

  @@unique([questionId, userId])
  @@index([questionId])
  @@map("student_answers")
}

model AnswerLike {
  id        String   @id @default(uuid())
  answerId  String   @map("answer_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  answer StudentAnswer @relation(fields: [answerId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([answerId, userId])
  @@map("answer_likes")
}

// ============================================
// COMENTÁRIOS (EXPERIÊNCIAS)
// ============================================

model Comment {
  id         String   @id @default(uuid())
  questionId String   @map("question_id")
  userId     String   @map("user_id")
  content    String
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  question Question      @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes    CommentLike[]

  @@index([questionId])
  @@map("comments")
}

model CommentLike {
  id        String   @id @default(uuid())
  commentId String   @map("comment_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
  @@map("comment_likes")
}

// ============================================
// QUESTÕES SALVAS E AVALIAÇÕES
// ============================================

model SavedQuestion {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  questionId String   @map("question_id")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
  @@map("saved_questions")
}

model AiRating {
  id         String   @id @default(uuid())
  aiAnswerId String   @map("ai_answer_id")
  userId     String   @map("user_id")
  rating     Int      @db.SmallInt // 1-5
  feedback   String?
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  aiAnswer AiAnswer @relation(fields: [aiAnswerId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([aiAnswerId, userId])
  @@map("ai_ratings")
}

// ============================================
// LINKS DE COMPARTILHAMENTO
// ============================================

model ShareLink {
  id          String    @id @default(uuid())
  slug        String    @unique @db.VarChar(10)
  examId      String    @map("exam_id")
  createdById String    @map("created_by")
  clickCount  Int       @default(0) @map("click_count")
  expiresAt   DateTime  @map("expires_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relations
  exam      Exam @relation(fields: [examId], references: [id], onDelete: Cascade)
  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([examId])
  @@index([createdById])
  @@index([expiresAt])
  @@map("share_links")
}

// ============================================
// ADMIN - AUDITORIA E MODERAÇÃO
// ============================================

model AuditLog {
  id         String   @id @default(uuid())
  adminId    String   @map("admin_id")
  action     String   @db.VarChar(50) // create, update, delete, suspend, etc
  entityType String   @db.VarChar(50) @map("entity_type") // user, exam, question, etc
  entityId   String?  @db.VarChar(50) @map("entity_id")
  changes    String?  @db.Text // JSON das mudanças (old -> new)
  reason     String?  @db.Text
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  admin User @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([createdAt])
  @@index([entityType])
  @@map("audit_logs")
}

model ContentFlag {
  id         String    @id @default(uuid())
  type       String    @db.VarChar(30) // question, answer, comment
  entityId   String    @db.VarChar(50) @map("entity_id")
  reason     String    @db.VarChar(255) // spam, offensive, inaccurate, etc
  reportedBy String?   @map("reported_by")
  status     String    @default("pending") @db.VarChar(30) // pending, reviewed, dismissed, deleted
  reviewedBy String?   @map("reviewed_by")
  reviewedAt DateTime? @map("reviewed_at")
  action     String?   @db.VarChar(50) // deleted, merged, approved, etc
  createdAt  DateTime  @default(now()) @map("created_at")

  // Relations (SetNull to preserve flags when user is deleted)
  reporter User? @relation("FlagReportedBy", fields: [reportedBy], references: [id], onDelete: SetNull)
  reviewer User? @relation("FlagReviewedBy", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([entityId])
  @@index([status])
  @@index([type])
  @@map("content_flags")
}
